import streamlit as st
import pandas as pd
import plotly.graph_objects as go
from lib.api import forecast  # <-- this must match the file above

def show():
    st.subheader("ðŸ”¥ Crypto â€” Flagship")
    with st.expander("Settings", expanded=True):
        symbol  = st.text_input("Symbol", value="BTCUSDT")
        horizon = st.slider("Horizon", 1, 30, 5)
        run     = st.button("Run Forecast")

    if not run:
        st.info("Set symbol & horizon, then click **Run Forecast**.")
        return

    try:
        res = forecast("crypto", symbol, horizon)
    except Exception as e:
        st.error(f"Forecast call failed: {e}")
        return

    evt = res.get("event", {})
    pts = (evt.get("forecast") or {}).get("points", [])
    if not pts:
        st.warning("No forecast points returned.")
        return

    df = pd.DataFrame(pts)
    fig = go.Figure()
    fig.add_trace(go.Scatter(x=pd.to_datetime(df["ts"], unit="s"), y=df["yhat"], mode="lines", name="yhat"))
    fig.add_trace(go.Scatter(x=pd.to_datetime(df["ts"], unit="s"), y=df["q10"], mode="lines", name="q10", line=dict(dash="dot")))
    fig.add_trace(go.Scatter(x=pd.to_datetime(df["ts"], unit="s"), y=df["q90"], mode="lines", name="q90", line=dict(dash="dot"), fill="tonexty"))
    fig.update_layout(margin=dict(l=10,r=10,t=30,b=10), height=420, title=f"{symbol} â€¢ {horizon} step forecast")
    st.plotly_chart(fig, use_container_width=True)

    m = evt.get("metrics", {})
    c1,c2,c3 = st.columns(3)
    c1.metric("Entropy", f"{m.get('entropy', 0):.2f}")
    c2.metric("Edge",    f"{m.get('edge', 0):.2f}")
    c3.metric("Regime",  m.get("regime", "â€”"))
